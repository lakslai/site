<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math test from Lakslai</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --red: #e21b3c; --blue: #1368ce; --yellow: #d89e00; --green: #26890c; --dark: #46178f; --cyan: #00f2ff; }
        body { font-family: 'Montserrat', sans-serif; background: var(--dark); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .container { width: 100%; max-width: 600px; text-align: center; box-sizing: border-box; }
        #ai-box { background: rgba(0,0,0,0.7); border: 3px solid var(--cyan); padding: 15px; border-radius: 20px; margin: 15px 0; font-family: monospace; font-size: 17px; line-height: 1.6; text-align: left; min-height: 130px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; word-spacing: 2px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .answer-btn { border: none; height: 85px; border-radius: 15px; font-size: 16px; font-weight: 900; color: white; cursor: pointer; }
        .btn-0 { background: var(--red); } .btn-1 { background: var(--blue); }
        .btn-2 { background: var(--yellow); } .btn-3 { background: var(--green); }
        #team-badge { background: var(--cyan); color: var(--dark); padding: 8px 15px; border-radius: 50px; font-weight: bold; margin-bottom: 10px; font-size: 14px; }
        #timer-circle { font-size: 30px; font-weight: 900; background: white; color: var(--dark); width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 10px auto; border: 4px solid var(--cyan); }
        .hidden { display: none !important; }
        input, select { padding: 12px; width: 90%; border-radius: 10px; border: none; margin: 8px; font-size: 16px; }
        .leaderboard { background: white; color: black; border-radius: 20px; padding: 15px; }
        .score-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 2px solid #eee; font-size: 19px; font-weight: bold; }
        .admin-panel { background: #000; padding: 20px; border: 3px solid red; margin-top: 10px; border-radius: 20px; text-align: left; width: 100%; box-sizing: border-box; }
        .admin-btn { background: #222; color: white; border: 1px solid #444; padding: 12px; margin: 5px; cursor: pointer; border-radius: 8px; width: 45%; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="main-title" onclick="secretClick()" style="cursor:pointer; user-select:none;">AI QUIZ ü§ñ</h1>

    <div id="login-screen">
        <input type="text" id="username" placeholder="–ò–º—è...">
        <select id="userteam">
            <option>–ö–æ–º–∞–Ω–¥–∞ 1</option><option>–ö–æ–º–∞–Ω–¥–∞ 2</option>
            <option>–ö–æ–º–∞–Ω–¥–∞ 3</option><option>–ö–æ–º–∞–Ω–¥–∞ 4</option>
        </select>
        <button class="answer-btn btn-1" style="width: 100%; height: 55px;" onclick="join()">–í–û–ô–¢–ò</button>
    </div>

    <div id="wait-screen" class="hidden">
        <div id="team-badge">–ö–æ–º–∞–Ω–¥–∞: <span id="my-team-name">?</span> | –ë–∞–ª–ª—ã: <span id="my-team-score">0</span></div>
        <h2 id="wait-text">–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è...</h2>
        <p>–£—á–∏—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–æ–ø—Ä–æ—Å</p>
    </div>

    <div id="game-ui-wrapper">
        <div id="game-screen" class="hidden">
            <div id="timer-circle">60</div>
            <h2 id="question-text" style="font-size: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <div id="ai-box"></div>
            <div id="answers-grid" class="grid">
                <button class="answer-btn btn-0" id="opt-0" onclick="sendAnswer(0)"></button>
                <button class="answer-btn btn-1" id="opt-1" onclick="sendAnswer(1)"></button>
                <button class="answer-btn btn-2" id="opt-2" onclick="sendAnswer(2)"></button>
                <button class="answer-btn btn-3" id="opt-3" onclick="sendAnswer(3)"></button>
            </div>
        </div>
    </div>

    <div id="finish-screen" class="hidden">
        <h1 style="color: gold;">–§–ò–ù–ê–õ –ë–ò–¢–í–´ üèÜ</h1>
        <div id="leaderboard-data" class="leaderboard"></div>
        <button class="answer-btn btn-1" style="width:100%; margin-top:20px;" onclick="location.reload()">–ó–ê–ù–û–ì–û</button>
    </div>

    <div id="admin-area" class="admin-panel hidden">
        <h3 style="color: red; margin: 0;">–†–ï–ñ–ò–ú –£–ß–ò–¢–ï–õ–Ø</h3>
        <div id="q-buttons"></div>
        <div style="margin-top: 15px;">
            <button onclick="showFinal()" class="admin-btn" style="background: gold; color: black;">üèÜ –§–ò–ù–ê–õ</button>
            <button onclick="resetGame()" class="admin-btn" style="background: #cc0000;">üß® –°–ë–†–û–°</button>
        </div>
        <div id="admin-log" style="font-size: 11px; margin-top:15px; background: #111; padding: 10px; border-radius: 10px; height: 150px; overflow-y: auto; border: 1px solid #333;"></div>
    </div>
</div>

<script>
// === –ö–û–ù–§–ò–ì FIREBASE (–í—Å—Ç–∞–≤—å —Å–≤–æ–π!) ===
const firebaseConfig = {
  apiKey: "AIzaSyC9QIPxowR7HdMFCxi0bRJ_Z20lXQXr5K0",
  authDomain: "ai-school-quiz.firebaseapp.com",
  databaseURL: "https://ai-school-quiz-default-rtdb.firebaseio.com",
  projectId: "ai-school-quiz",
  storageBucket: "ai-school-quiz.firebasestorage.app",
  messagingSenderId: "155195208675",
  appId: "1:155195208675:web:21799fc642e88ddce826d6",
  measurementId: "G-Y4N2NGVNS9"
};
// =====================================

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const questions = [
    { q: "log_{2} 16 + log_{3} 1/27", opts: ["0", "1", "-1", "2"], correct: 1, ai: "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –í –∫–∞–∫—É—é —Å—Ç–µ–ø–µ–Ω—å –Ω–∞–¥–æ –≤–æ–∑–≤–µ—Å—Ç–∏ 2, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å 16? –ê 3, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å 1/27 
–æ—Ç–≤–µ—Ç 4 + (-3) = 1." },
    { q: "–ù–∞–π–¥–∏—Ç–µ —Å—É–º–º—É 4 + 2 + 1 + 0,5 + ...", opts: ["6", "7", "8", "12"], correct: 2, ai: "–°–µ–∫—Ä–µ—Ç: –≠—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ —É–±—ã–≤–∞—é—â–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è. –§–æ—Ä–º—É–ª–∞: S = b_1 / {1 - q}. b_1 = 4, —à–∞–≥ q = 0,5  –û—Ç–≤–µ—Ç 8." },
    { q: "–ï—Å–ª–∏ —Ä–µ–±—Ä–æ –∫—É–±–∞ —É–≤–µ–ª–∏—á–∏—Ç—å –≤ 4 —Ä–∞–∑–∞, –≤–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —É–≤–µ–ª–∏—á–∏—Ç—Å—è –µ–≥–æ –æ–±—ä–µ–º?", opts: ["64 —Ä–∞–∑–∞", "16 —Ä–∞–∑", "12 —Ä–∞–∑", "4 —Ä–∞–∑–∞"], correct: 0, ai: "–ü—Ä–∞–≤–∏–ª–æ: –û–±—ä–µ–º —Ä–∞—Å—Ç–µ—Ç –∫–∞–∫ –∫—É–± –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞" }
];

let myID = ""; let myTeam = ""; let clickCount = 0; let isAdmin = false;

function secretClick() {
    clickCount++;
    if(clickCount >= 5) {
        isAdmin = true;
        document.getElementById('admin-area').classList.remove('hidden');
        document.getElementById('game-ui-wrapper').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('wait-screen').classList.add('hidden');
    }
}

function join() {
    let name = document.getElementById('username').value;
    myTeam = document.getElementById('userteam').value;
    if(!name) return alert("–í–≤–µ–¥–∏ –∏–º—è!");
    myID = name + "_" + Math.floor(Math.random()*100);
    document.getElementById('my-team-name').innerText = myTeam;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('wait-screen').classList.remove('hidden');
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ë–ê–õ–õ–û–í
async function sendAnswer(idx) {
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('wait-screen').classList.remove('hidden');

    const taskSnap = await db.ref('currentTask').once('value');
    const correctIdx = taskSnap.val().correct;
    
    const roundSnap = await db.ref('roundAnswers').once('value');
    const roundData = roundSnap.val() || {};
    const hasTeamAnswered = Object.values(roundData).some(a => a.team === myTeam);

    if (!hasTeamAnswered) {
        // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ü–†–ê–í–ò–õ–¨–ù–´–• –æ—Ç–≤–µ—Ç–æ–≤ —É–∂–µ –±—ã–ª–æ –¥–æ –Ω–∞—Å
        let correctOrder = Object.values(roundData).filter(a => a.correct === true).length;
        let points = 0;

        if (idx === correctIdx) {
            if (correctOrder === 0) points = 10;
            else if (correctOrder === 1) points = 5;
            else if (correctOrder === 2) points = 1;
        }

        db.ref('roundAnswers').push({ 
            team: myTeam, 
            correct: (idx === correctIdx), 
            points: points 
        });

        if (points > 0) {
            db.ref('teamScores/' + myTeam).transaction(c => (c || 0) + points);
        }
    }
}

questions.forEach((q, i) => {
    let btn = document.createElement('button'); btn.className = "admin-btn"; btn.innerText = "–í–û–ü–†–û–° " + (i+1);
    btn.onclick = () => {
        db.ref('roundAnswers').remove();
        db.ref('gameState').set({ status: "play", qId: i });
        db.ref('currentTask').set(q);
    };
    document.getElementById('q-buttons').appendChild(btn);
});

function showFinal() { db.ref('gameState').set({ status: "finish" }); }
function resetGame() { if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É?")) { db.ref().remove(); location.reload(); } }

db.ref('gameState').on('value', snap => {
    const s = snap.val(); if(!s) return;
    if(s.status === "play") {
        const q = questions[s.qId];
        document.getElementById('wait-screen').classList.add('hidden');
        document.getElementById('finish-screen').classList.add('hidden');
        if(!isAdmin) document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('question-text').innerText = q.q;
        q.opts.forEach((t, i) => document.getElementById('opt-'+i).innerText = t);
        typeAI(q.ai); startTimer(60);
    } else if(s.status === "finish") {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('wait-screen').classList.add('hidden');
        document.getElementById('finish-screen').classList.remove('hidden');
        renderFinalScores();
    }
});

db.ref('teamScores').on('value', snap => {
    const s = snap.val() || {};
    if(myTeam && s[myTeam]) document.getElementById('my-team-score').innerText = s[myTeam];
});

function typeAI(text) {
    let i = 0; let box = document.getElementById('ai-box'); box.innerText = "ü§ñ ";
    if(window.aiInt) clearInterval(window.aiInt);
    window.aiInt = setInterval(() => {
        box.innerText += text[i]; i++;
        if(i >= text.length) clearInterval(window.aiInt);
    }, 130);
}

function startTimer(s) {
    let t = s; let el = document.getElementById('timer-circle');
    if(window.timerInt) clearInterval(window.timerInt);
    window.timerInt = setInterval(() => {
        t--; el.innerText = t;
        if(t <= 0) { clearInterval(window.timerInt); document.getElementById('game-screen').classList.add('hidden'); }
    }, 1000);
}

function renderFinalScores() {
    db.ref('teamScores').once('value', snap => {
        const s = snap.val() || {};
        const board = document.getElementById('leaderboard-data');
        board.innerHTML = "";
        const teams = ["–ö–æ–º–∞–Ω–¥–∞ 1", "–ö–æ–º–∞–Ω–¥–∞ 2", "–ö–æ–º–∞–Ω–¥–∞ 3", "–ö–æ–º–∞–Ω–¥–∞ 4"];
        teams.sort((a, b) => (s[b] || 0) - (s[a] || 0));
        teams.forEach((t, index) => {
            let icon = index === 0 ? "ü•á" : (index === 1 ? "ü•à" : (index === 2 ? "ü•â" : ""));
            board.innerHTML += `<div class="score-row"><span>${icon} ${t}</span><span>${s[t] || 0} –±–∞–ª–ª–æ–≤</span></div>`;
        });
    });
}

db.ref('roundAnswers').on('value', snap => {
    let log = document.getElementById('admin-log'); log.innerHTML = "<b>–õ–û–ì –†–ê–£–ù–î–ê:</b><br>";
    if(snap.val()) Object.values(snap.val()).forEach(a => {
        log.innerHTML += `${a.correct ? "‚úÖ" : "‚ùå"} ${a.team} (+${a.points || 0})<br>`;
    });
});
</script>
</body>
</html>

