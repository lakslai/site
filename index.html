<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENT Math Battle</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --red: #e21b3c; --blue: #1368ce; --yellow: #d89e00; --green: #26890c; --dark: #46178f; --cyan: #00f2ff; }
        body { font-family: 'Montserrat', sans-serif; background: var(--dark); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .container { width: 100%; max-width: 600px; text-align: center; box-sizing: border-box; }
        #ai-box { background: rgba(0,0,0,0.7); border: 3px solid var(--cyan); padding: 20px; border-radius: 20px; margin: 15px 0; font-family: monospace; font-size: 17px; line-height: 1.6; text-align: left; min-height: 140px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; word-spacing: 2px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .answer-btn { border: none; height: 90px; border-radius: 18px; font-size: 18px; font-weight: 900; color: white; cursor: pointer; }
        .btn-0 { background: var(--red); } .btn-1 { background: var(--blue); }
        .btn-2 { background: var(--yellow); } .btn-3 { background: var(--green); }
        #team-badge { background: var(--cyan); color: var(--dark); padding: 8px 15px; border-radius: 50px; font-weight: bold; margin-bottom: 10px; font-size: 14px; }
        #timer-circle { font-size: 30px; font-weight: 900; background: white; color: var(--dark); width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 10px auto; border: 4px solid var(--cyan); }
        .hidden { display: none !important; }
        input, select { padding: 12px; width: 90%; border-radius: 10px; border: none; margin: 8px; font-size: 16px; }
        .leaderboard { background: white; color: black; border-radius: 20px; padding: 20px; text-align: left; }
        .score-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 2px solid #eee; font-size: 20px; font-weight: bold; }
        .admin-panel { background: #000; padding: 20px; border: 3px solid red; margin-top: 10px; border-radius: 20px; text-align: left; width: 100%; box-sizing: border-box; }
        .admin-btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .admin-btn { background: #222; color: white; border: 1px solid #444; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="main-title" onclick="secretClick()" style="cursor:pointer; user-select:none;">ENT MATH BATTLE üìê</h1>

    <div id="login-screen">
        <input type="text" id="username" placeholder="–¢–≤–æ–µ –ò–º—è...">
        <select id="userteam">
            <option>–ö–æ–º–∞–Ω–¥–∞ 1</option><option>–ö–æ–º–∞–Ω–¥–∞ 2</option>
            <option>–ö–æ–º–∞–Ω–¥–∞ 3</option><option>–ö–æ–º–∞–Ω–¥–∞ 4</option>
        </select>
        <button class="answer-btn btn-1" style="width: 100%; height: 60px;" onclick="join()">–í –ë–û–ô!</button>
    </div>

    <div id="wait-screen" class="hidden">
        <div id="team-badge">–¢–≤–æ—è –∫–æ–º–∞–Ω–¥–∞: <span id="my-team-name">?</span> | –°—á–µ—Ç: <span id="my-team-score">0</span></div>
        <h2 id="wait-text">–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è...</h2>
        <p>–£—á–∏—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∑–∞–¥–∞—á—É</p>
    </div>

    <div id="game-wrapper">
        <div id="game-screen" class="hidden">
            <div id="timer-circle">60</div>
            <h2 id="question-text" style="font-size: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <div id="ai-box"></div>
            <div id="answers-grid" class="grid">
                <button class="answer-btn btn-0" id="opt-0" onclick="sendAnswer(0)"></button>
                <button class="answer-btn btn-1" id="opt-1" onclick="sendAnswer(1)"></button>
                <button class="answer-btn btn-2" id="opt-2" onclick="sendAnswer(2)"></button>
                <button class="answer-btn btn-3" id="opt-3" onclick="sendAnswer(3)"></button>
            </div>
        </div>
    </div>

    <div id="finish-screen" class="hidden">
        <h1 style="color: gold;">–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ï–ù–¢ üèÜ</h1>
        <div id="leaderboard-data" class="leaderboard"></div>
        <button class="answer-btn btn-1" style="width:100%; margin-top:20px;" onclick="location.reload()">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
    </div>

    <div id="admin-area" class="admin-panel hidden">
        <h3 style="color: red; margin: 0 0 10px 0;">–£–ü–†–ê–í–õ–ï–ù–ò–ï</h3>
        <div id="q-buttons" class="admin-btn-grid"></div>
        <div style="display: flex; gap: 10px;">
            <button onclick="showFinal()" class="admin-btn" style="background: gold; color: black; width: 50%;">–§–ò–ù–ê–õ</button>
            <button onclick="resetGame()" class="admin-btn" style="background: #cc0000; width: 50%;">–°–ë–†–û–°</button>
        </div>
        <div id="admin-log" style="font-size: 11px; margin-top:15px; background: #111; padding: 10px; border-radius: 10px; height: 150px; overflow-y: auto; border: 1px solid #333;"></div>
    </div>
</div>

<script>
// === –¢–í–û–ô CONFIG FIREBASE (–í—Å—Ç–∞–≤—å —Å–≤–æ–π!) ===
const firebaseConfig = {
  apiKey: "AIzaSyC9QIPxowR7HdMFCxi0bRJ_Z20lXQXr5K0",
  authDomain: "ai-school-quiz.firebaseapp.com",
  databaseURL: "https://ai-school-quiz-default-rtdb.firebaseio.com",
  projectId: "ai-school-quiz",
  storageBucket: "ai-school-quiz.firebasestorage.app",
  messagingSenderId: "155195208675",
  appId: "1:155195208675:web:21799fc642e88ddce826d6",
  measurementId: "G-Y4N2NGVNS9"
};
// =====================================

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const questions = [
    { q: "–í—ã—á–∏—Å–ª–∏—Ç–µ: log‚ÇÇ 16 + log‚ÇÉ (1/27)", opts: ["1", "0", "7", "-1"], correct: 0, ai: "–í—Å–ø–æ–º–∏–Ω–∞–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∞—Ä–∏—Ñ–º–∞. \n2 –≤ –∫–∞–∫–æ–π —Å—Ç–µ–ø–µ–Ω–∏ –¥–∞—Å—Ç 16? (–≠—Ç–æ 4). \n3 –≤ –∫–∞–∫–æ–π —Å—Ç–µ–ø–µ–Ω–∏ –¥–∞—Å—Ç 1/27? (–≠—Ç–æ -3). \n–ò—Ç–æ–≥–æ: 4 + (-3) = 1. " },
    { q: "–°—É–º–º–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏: 4; 2; 1; 0,5...", opts: ["6", "7", "8", "10"], correct: 2, ai: "–≠—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ —É–±—ã–≤–∞—é—â–∞—è –≥–µ–æ–º. –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è. \n–§–æ—Ä–º—É–ª–∞: S = b‚ÇÅ / (1 - q). \nb‚ÇÅ = 4, q = 0,5. \n–í—ã—á–∏—Å–ª—è–µ–º: 4 / (1 - 0,5) = 4 / 0,5 = 8. " },
    { q: "–†–µ–±—Ä–æ –∫—É–±–∞ —É–≤–µ–ª–∏—á. –≤ 3 —Ä–∞–∑–∞. –û–±—ä–µ–º?", opts: ["3 —Ä–∞–∑–∞", "9 —Ä–∞–∑", "27 —Ä–∞–∑", "6 —Ä–∞–∑"], correct: 2, ai: "–û–±—ä–µ–º –∫—É–±–∞ V = a¬≥. \n–ï—Å–ª–∏ —Å—Ç–æ—Ä–æ–Ω–∞ —Å—Ç–∞–ª–∞ 3a, —Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–º V = (3a)¬≥. \n3 –≤ –∫—É–±–µ —ç—Ç–æ 27. –û–±—ä–µ–º –≤—ã—Ä–∞—Å—Ç–µ—Ç –≤ 27 —Ä–∞–∑." },
    { q: "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é f(x) = x¬≤ + 5x", opts: ["2x + 5", "x + 5", "2x", "5x"], correct: 0, ai: "–ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–æ: (x‚Åø)' = n*x‚Åø‚Åª¬π. \n–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è x¬≤ —ç—Ç–æ 2x. \n–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è 5x —ç—Ç–æ 5. \n–†–µ–∑—É–ª—å—Ç–∞—Ç: 2x + 5. " },
    { q: "–†–µ—à–∏—Ç–µ: 2^(x+1) = 16", opts: ["2", "3", "4", "5"], correct: 1, ai: "–ü—Ä–∏–≤–æ–¥–∏–º –∫ –æ–¥–Ω–æ–º—É –æ—Å–Ω–æ–≤–∞–Ω–∏—é. \n16 —ç—Ç–æ 2‚Å¥. \n–ó–Ω–∞—á–∏—Ç: x + 1 = 4. \n–û—Ç—Å—é–¥–∞ x = 3. " },
    { q: "cos(x) = 1/2. –ß–µ–º—É —Ä–∞–≤–Ω–æ x?", opts: ["30¬∞", "45¬∞", "60¬∞", "90¬∞"], correct: 2, ai: "–í—Å–ø–æ–º–∏–Ω–∞–µ–º —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é —Ç–∞–±–ª–∏—Ü—É. \n–ö–æ—Å–∏–Ω—É—Å –∫–∞–∫–æ–≥–æ —É–≥–ª–∞ —Ä–∞–≤–µ–Ω 0,5? \n–≠—Ç–æ 60 –≥—Ä–∞–¥—É—Å–æ–≤ (–∏–ª–∏ œÄ/3 –≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö). " },
    { q: "–ü–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞ —Å —Ä–∞–¥–∏—É—Å–æ–º R=4", opts: ["4œÄ", "8œÄ", "16œÄ", "32œÄ"], correct: 2, ai: "–§–æ—Ä–º—É–ª–∞ –ø–ª–æ—â–∞–¥–∏ –∫—Ä—É–≥–∞: S = œÄR¬≤. \n–†–∞–¥–∏—É—Å 4, –∑–Ω–∞—á–∏—Ç R¬≤ = 16. \n–û—Ç–≤–µ—Ç: 16œÄ. " },
    { q: "–í–µ–∫—Ç–æ—Ä a(3; 4). –ù–∞–π–¥–∏—Ç–µ –µ–≥–æ –¥–ª–∏–Ω—É.", opts: ["5", "7", "25", "12"], correct: 0, ai: "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–æ—Ä–µ–º—É –ü–∏—Ñ–∞–≥–æ—Ä–∞ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–æ–≤. \nL = ‚àö(x¬≤ + y¬≤). \nL = ‚àö(3¬≤ + 4¬≤) = ‚àö(9 + 16) = ‚àö25 = 5. " }
];

let myID = ""; let myTeam = ""; let clickCount = 0; let isAdmin = false;

function secretClick() {
    clickCount++;
    document.getElementById('main-title').style.color = "cyan";
    setTimeout(() => { document.getElementById('main-title').style.color = "white"; }, 150);
    if(clickCount >= 5) {
        isAdmin = true;
        document.getElementById('admin-area').classList.remove('hidden');
        document.getElementById('game-wrapper').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('wait-screen').classList.add('hidden');
    }
}

function join() {
    let name = document.getElementById('username').value;
    myTeam = document.getElementById('userteam').value;
    if(!name) return alert("–ò–º—è!");
    myID = name + "_" + Math.floor(Math.random()*100);
    document.getElementById('my-team-name').innerText = myTeam;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('wait-screen').classList.remove('hidden');
}

async function sendAnswer(idx) {
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('wait-screen').classList.remove('hidden');
    document.getElementById('wait-text').innerText = "–û–¢–í–ï–¢ –ü–†–ò–ù–Ø–¢!";

    const taskSnap = await db.ref('currentTask').once('value');
    if(!taskSnap.exists()) return;
    const correctIdx = taskSnap.val().correct;
    
    const roundSnap = await db.ref('roundAnswers').once('value');
    const roundData = roundSnap.val() || {};
    const hasTeamAnswered = Object.values(roundData).some(a => a.team === myTeam);

    if (!hasTeamAnswered) {
        let correctOrder = Object.values(roundData).filter(a => a.correct === true).length;
        let points = 0;
        if (idx === correctIdx) {
            if (correctOrder === 0) points = 10;
            else if (correctOrder === 1) points = 5;
            else if (correctOrder === 2) points = 1;
        }
        db.ref('roundAnswers').push({ team: myTeam, correct: (idx === correctIdx), points: points });
        if (points > 0) {
            db.ref('teamScores/' + myTeam).transaction(c => (c || 0) + points);
        }
    }
}

const qBtnContainer = document.getElementById('q-buttons');
questions.forEach((q, i) => {
    let btn = document.createElement('button');
    btn.className = "admin-btn";
    btn.innerText = "Q" + (i + 1);
    btn.onclick = () => {
        db.ref('roundAnswers').remove();
        db.ref('gameState').set({ status: "play", qId: i });
        db.ref('currentTask').set(q);
    };
    qBtnContainer.appendChild(btn);
});

function showFinal() { db.ref('gameState').set({ status: "finish" }); }
function resetGame() { if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–ª—ã –∫–æ–º–∞–Ω–¥?")) { db.ref().remove(); location.reload(); } }

db.ref('gameState').on('value', snap => {
    const s = snap.val(); if(!s) return;
    if(s.status === "play") {
        const q = questions[s.qId];
        document.getElementById('wait-screen').classList.add('hidden');
        document.getElementById('finish-screen').classList.add('hidden');
        if(!isAdmin) document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('question-text').innerText = q.q;
        q.opts.forEach((t, i) => { document.getElementById('opt-'+i).innerText = t; });
        typeAI(q.ai); startTimer(60);
    } else if(s.status === "finish") {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('wait-screen').classList.add('hidden');
        document.getElementById('finish-screen').classList.remove('hidden');
        renderFinalScores();
    }
});

db.ref('teamScores').on('value', snap => {
    const s = snap.val() || {};
    if(myTeam && s[myTeam]) document.getElementById('my-team-score').innerText = s[myTeam];
});

function typeAI(text) {
    let i = 0; let box = document.getElementById('ai-box'); box.innerText = "ü§ñ ";
    if(window.aiInt) clearInterval(window.aiInt);
    window.aiInt = setInterval(() => {
        box.innerText += text[i]; i++;
        if(i >= text.length) clearInterval(window.aiInt);
    }, 120);
}

function startTimer(s) {
    let t = s; let el = document.getElementById('timer-circle');
    if(window.timerInt) clearInterval(window.timerInt);
    window.timerInt = setInterval(() => {
        t--; el.innerText = t;
        if(t <= 0) { clearInterval(window.timerInt); document.getElementById('game-screen').classList.add('hidden'); }
    }, 1000);
}

function renderFinalScores() {
    db.ref('teamScores').once('value', snap => {
        const s = snap.val() || {};
        const board = document.getElementById('leaderboard-data');
        board.innerHTML = "";
        const teams = ["–ö–æ–º–∞–Ω–¥–∞ 1", "–ö–æ–º–∞–Ω–¥–∞ 2", "–ö–æ–º–∞–Ω–¥–∞ 3", "–ö–æ–º–∞–Ω–¥–∞ 4"];
        teams.sort((a, b) => (s[b] || 0) - (s[a] || 0));
        teams.forEach((t, index) => {
            let icon = index === 0 ? "ü•á" : (index === 1 ? "ü•à" : (index === 2 ? "ü•â" : ""));
            board.innerHTML += `<div class="score-row"><span>${icon} ${t}</span><span>${s[t] || 0}</span></div>`;
        });
    });
}

db.ref('roundAnswers').on('value', snap => {
    let log = document.getElementById('admin-log'); log.innerHTML = "<b>LOG:</b><br>";
    if(snap.val()) Object.values(snap.val()).forEach(a => {
        log.innerHTML += `${a.correct ? "‚úÖ" : "‚ùå"} ${a.team} (+${a.points || 0})<br>`;
    });
});
</script>
</body>
</html>
